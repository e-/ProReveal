<div *ngIf="node && node.query">
<header class="query-desc mt-2">
    <!-- <strong>Q{{ node.query.id }}: </strong> -->

<span *ngIf="node.query.target === null">COUNT(<small><fa-icon [icon]="['fas', 'asterisk']"></fa-icon></small>)</span>
<span *ngIf="node.query.target !== null">
    <form class="form-inline aggregate-form">
    <select class="form-control form-control-md"
        (change)="setApproximator($event.target.value)"
        [ngModel]="node.query.approximator.name"
        name="approximator"
        >
        <option *ngFor="let approx of approximators" [value]="approx.name">
            {{ approx.name.toUpperCase() }}
        </option>
    </select>
    </form>
    (<field-badge [field]="node.query.target" class="mr-1"></field-badge>{{ node.query.target.name }})

    </span><span class="keyword ml-1">GROUPED BY</span>
    <ng-container *ngFor="let field of node.query.groupBy.fields; index as i">
        <field-badge [field]="field" class="ml-2 mr-1"></field-badge>{{ field.name }}<span *ngIf="node.query.groupBy.fields.length > 1 && i < node.query.groupBy.fields.length - 1" class="keyword">,</span>
    </ng-container>

    <small class="pl-1">created {{ node.query.createdAt | amTimeAgo }}</small>
</header>

<hr>

<p [hidden]="node.query.recentProgress.processedBlocks > 0" class="alert alert-primary" role="alert">
    This query has not been started yet. Reorder <strong>the ongoing list</strong> to give a high priority to this query.
</p>

<div [hidden]="node.query.recentProgress.processedBlocks === 0" class="vis-content">
    <div class="progress-control">
        <div class="progress mb-2">
            <div class="progress-bar" role="progressbar"
                [style.width.%]="node.query.recentProgress.processedPercent() * 100"
                [attr.aria-valuenow]="node.query.recentProgress.processedPercent() * 100"
                aria-valuemin="0" aria-valuemax="100">
            </div>
            <div class="progress-bar progress-bar-striped progress-bar-animated" role="progressbar"
                [style.width.%]="node.query.recentProgress.ongoingPercent() * 100"
                [attr.aria-valuenow]="node.query.recentProgress.ongoingPercent() * 100"
                aria-valuemin="0" aria-valuemax="100">
            </div>
        </div>
        <div class="text-center" id="visible-progress-indicator"
            [style.left.%]="node.query.visibleProgress.processedPercent() * 100"
        >
            <fa-icon [icon]="['fas', 'caret-down']"></fa-icon> <br />
            <fa-icon [icon]="['far', 'eye']"></fa-icon>
        </div>
    </div>
    <div class="d-flex flex-row justify-content-between mb-1">
        <div class="pt-1 flex-grow-1">
            Processed
            <span class="font-weight-bold text-primary">{{ node.query.recentProgress.processedRows | number }}</span>
            of
            <span [ngPlural]="node.query.recentProgress.totalRows">
                <ng-template ngPluralCase="=1"><span class="font-weight-bold">1</span> row</ng-template>
                <ng-template ngPluralCase="other"><span class="font-weight-bold">{{ node.query.recentProgress.totalRows | number }}</span> rows</ng-template>
            </span>

            (<span class="font-weight-bold text-primary">{{ node.query.recentProgress.processedBlocks | number }}</span>
            of
            <span [ngPlural]="node.query.recentProgress.totalBlocks">
                <ng-template ngPluralCase="=1"><span class="font-weight-bold">1</span> block</ng-template>
                <ng-template ngPluralCase="other"><span class="font-weight-bold">{{ node.query.recentProgress.totalBlocks | number }}</span> blocks</ng-template>
            </span>,
            {{ node.query.recentProgress.processedPercent() | percent }})
        </div>
        <button type="button" class="btn btn-light btn-sm ml-1"
            (click)="node.query.updateAutomatically=!node.query.updateAutomatically">
            <fa-icon icon="check-square" [hidden]="!node.query.updateAutomatically"></fa-icon>
            <fa-icon [icon]="['far', 'square']" [hidden]="node.query.updateAutomatically"></fa-icon>
            Update automatically
        </button>

        <button type="button" class="btn btn-light btn-sm ml-1"
            [disabled]="node.query.updateAutomatically"
            (click)="node.query.sync();forceUpdate()">
            <fa-icon icon="sync-alt"></fa-icon>
            Sync
        </button>
    </div>

    <svg class="mt-2" #svg></svg>

    <tooltip #tooltip></tooltip>

    <!-- <div>
        Sort a categorical axis
        <div class="btn-group" role="group">
            <button type="button" class="btn btn-outline-secondary">Data</button>
            <button type="button" class="btn btn-outline-secondary">Alaphabetical</button>
            <button type="button" class="btn btn-outline-secondary">Value</button>
        </div>
    </div>

    <div>
        Sort a numerical axis (binning)
        <div class="btn-group" role="group">
            <button type="button" class="btn btn-outline-secondary">Default</button>
            <button type="button" class="btn btn-outline-secondary">Value</button>
        </div>
    </div> -->
</div>
</div>

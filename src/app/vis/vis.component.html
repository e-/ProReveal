<div *ngIf="query && query">
<header>
    <query-indicator [query]="query"
        (approximatorChanged)="approximatorChanged($event)"
    ></query-indicator>
    <small class="pl-1">updated {{ query.lastUpdatedAt | amTimeAgo }}</small>
</header>

<hr class="mt-1 mb-2">

<p [hidden]="query.recentProgress.processedBlocks > 0" class="alert alert-primary" role="alert">
    This query has not been started yet. Reorder <strong>the ongoing list</strong> to give a high priority to this query.
</p>

<div [hidden]="query.recentProgress.processedBlocks === 0" class="vis-content"
    (click)="backgroundClick()">
    <div class="progress-control">
        <div class="progress mb-2">
            <div class="progress-bar" role="progressbar"
                [style.width.%]="query.recentProgress.processedPercent() * 100"
                [attr.aria-valuenow]="query.recentProgress.processedPercent() * 100"
                aria-valuemin="0" aria-valuemax="100">
            </div>
            <div class="progress-bar progress-bar-striped progress-bar-animated" role="progressbar"
                [style.width.%]="query.recentProgress.ongoingPercent() * 100"
                [attr.aria-valuenow]="query.recentProgress.ongoingPercent() * 100"
                aria-valuemin="0" aria-valuemax="100">
            </div>
        </div>
        <div class="text-center" id="visible-progress-indicator"
            [style.left.%]="query.visibleProgress.processedPercent() * 100"
        >
            <fa-icon [icon]="['fas', 'caret-down']"></fa-icon> <br />
            <fa-icon [icon]="['far', 'eye']"></fa-icon>
        </div>
    </div>
    <div class="d-flex flex-row justify-content-between mb-1">
        <div class="pt-1 flex-grow-1">
            Processed
            <span class="font-weight-bold text-primary">{{ query.recentProgress.processedRows | number }}</span>
            of
            <span [ngPlural]="query.recentProgress.totalRows">
                <ng-template ngPluralCase="=1"><span class="font-weight-bold">1</span> row</ng-template>
                <ng-template ngPluralCase="other"><span class="font-weight-bold">{{ query.recentProgress.totalRows | number }}</span> rows</ng-template>
            </span>

            (<span class="font-weight-bold text-primary">{{ query.recentProgress.processedBlocks | number }}</span>
            of
            <span [ngPlural]="query.recentProgress.totalBlocks">
                <ng-template ngPluralCase="=1"><span class="font-weight-bold">1</span> block</ng-template>
                <ng-template ngPluralCase="other"><span class="font-weight-bold">{{ query.recentProgress.totalBlocks | number }}</span> blocks</ng-template>
            </span>,
            {{ query.recentProgress.processedPercent() | percent }})
        </div>

        <button type="button" class="btn btn-light btn-sm ml-1"
            [hidden]="!query.aggregationLevel"
            [disabled]="query.aggregationLevel == query.minLevel || query.safeguards.length > 0"
            (click)="splitBins()">
            <fa-icon [icon]="['fas', 'caret-up']"></fa-icon>
            Split bins
        </button>

        <button type="button" class="btn btn-light btn-sm ml-1"
            [hidden]="!query.aggregationLevel"
            [disabled]="query.aggregationLevel == query.maxLevel || query.safeguards.length > 0"
            (click)="mergeBins()">
            <fa-icon [icon]="['fas', 'caret-down']"></fa-icon>
            Merge bins
        </button>

        <button type="button" class="btn btn-light btn-sm ml-1"
            (click)="query.updateAutomatically=!query.updateAutomatically">
            <fa-icon icon="check-square" [hidden]="!query.updateAutomatically"></fa-icon>
            <fa-icon [icon]="['far', 'square']" [hidden]="query.updateAutomatically"></fa-icon>
            Update automatically
        </button>

        <button type="button" class="btn btn-light btn-sm ml-1"
            [disabled]="query.updateAutomatically"
            (click)="query.sync();forceUpdate()">
            <fa-icon icon="sync-alt"></fa-icon>
            Sync
        </button>
    </div>

    <button class="btn btn-sm btn-secondary w-100" [hidden]="!limitNumCategories"
        (click)="showAllCategories()">
        There are too many categories. Click here to see all {{ numCategories | number }} categories
    </button>

    <svg class="mt-2" #svg></svg>

    <div #dw class="dropdown-menu" id="dropdown"
        [style.top.px]="dropdownTop"
        [style.left.px]="dropdownLeft"
        (click)="$event.stopPropagation()"
        [hidden]="!isDropdownVisible">
        <h6 class="dropdown-header px-3" *ngIf="selectedDatum">{{ selectedDatum.keys.list[0].valueString() }}</h6>
        <a class="dropdown-item px-3" href="#" (click)="filterClick()">
            <fa-icon class="mr-1" [icon]="['fas', 'filter']"></fa-icon>
            Filter these data items
        </a>
        <a class="dropdown-item px-3" href="#" (click)="safeguardClick()">
            <fa-icon class="mr-1" [icon]="['far', 'eye']"></fa-icon>
            Create a safeguard
        </a>
        <a class="dropdown-item px-3" href="#" (click)="detailClick()">
            <fa-icon class="mr-1" [icon]="['fas', 'table']"></fa-icon>
            Show data items
        </a>
    </div>


    <div #qcw
        id="query-creator-wrapper"
        class="mt-1"
        [style.top.px]="queryCreatorTop"
        [style.left.px]="queryCreatorLeft"
        [hidden]="!isQueryCreatorVisible"
        (click)="$event.stopPropagation()">
        <query-creator #qc id="query-creator" class="border rounded"
            [dataset]="this.query.dataset"
            (created)="queryCreated.emit($event); isQueryCreatorVisible=false; queryCreatorDatum = null;"
            (creationCancelled)="isQueryCreatorVisible=false; queryCreatorDatum = null;"
        ></query-creator>
    </div>

    <tooltip #tooltip></tooltip>
</div>
</div>

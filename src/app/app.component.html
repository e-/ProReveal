<div id="wrapper">
    <section class="navbar navbar-dark bg-dark box-shadow d-flex justify-content-start" id="navbar">
        <a href="#" class="navbar-brand ml-2">
            <img src="assets/eye-white.png" width="24" height="24" class="d-inline-block align-text-bottom" alt="">
            ProReveal
        </a>

        <button (click)="toggleMetadataEditor()" class="btn btn-sm btn-dark" id="open-metadata-editor">
            <fa-icon icon="folder-open"></fa-icon>
            <small> (movies.json)</small>
        </button>
        <span class="text-light">
            Dev menu
        </span>
        &nbsp;
        <button class="btn btn-sm btn-primary" (click)="play()" [hidden]="isPlaying">
            <fa-icon [icon]="['fas', 'play']"></fa-icon>
            Run a job every 3 seconds
        </button>
        <button class="btn btn-sm btn-danger" (click)="pause()" [hidden]="!isPlaying">
            <fa-icon [icon]="['fas', 'pause']"></fa-icon>
            Pause
        </button>
        &nbsp;
        <button class="btn btn-sm btn-secondary" (click)="run(1)">Run a job</button>
        &nbsp;
        <button class="btn btn-sm btn-secondary" (click)="run(10)">Run 10 jobs</button>
        &nbsp;
        <button class="btn btn-sm btn-secondary" (click)="run(100)">Run 100 jobs</button>&nbsp;
        <button class="btn btn-sm btn-secondary" (click)="testC()">C</button>&nbsp;
        <button class="btn btn-sm btn-secondary" (click)="testN()">N</button>&nbsp;
        <button class="btn btn-sm btn-secondary" (click)="testCN()">CN</button>&nbsp;
        <button class="btn btn-sm btn-secondary" (click)="testNN()">NN</button>&nbsp;
        <button class="btn btn-sm btn-secondary" (click)="testCC()">CC</button>&nbsp;
    </section>
    <section id="node-view" class="border-right">
        <section id="new-node" class="border-bottom">
            <button class="btn btn-secondary w-100 rounded-0" (click)="creating=!creating">
                <fa-icon [icon]="['fas', 'caret-down']" [hidden]="!creating"></fa-icon>
                <fa-icon [icon]="['fas', 'caret-right']" [hidden]="creating"></fa-icon>
                New Visualization
            </button>

            <query-creator id="query-creator" [hidden]="!creating"
                [dataset]="engine.dataset"
                (created)="create($event.fields, $event.query, Priority.Highest)"
                (creationCancelled)="creating=false"
                ></query-creator>
        </section>
        <h3 id="completed-node-view-header" class="section-header p-1 border-bottom border-right">Completed Queries</h3>
        <section id="completed-node-view" class="styled-scroll">
            <ng-container *ngFor="let node of completedNodes">
                <div class="query" (click)="nodeSelected(node)"
                    [class.selected]="activeNode === node"
                    [class.highlighted]="highlightedNode === node">
                    <div class="field-names m-0 p-0">
                        <div *ngFor="let field of node.fields">
                            <field-badge [field]="field"></field-badge>
                            {{ field.name }}
                        </div>
                        <div *ngIf="node.query.where.length > 0" class="filtered-by">
                            FILTERED BY
                        </div>
                        <div *ngFor="let pred of node.query.where.predicates">
                            <field-badge [field]="pred.target" class="mr-1"></field-badge>
                            <predicate-indicator [predicate]="pred"></predicate-indicator>>
                        </div>
                    </div>
                </div>
                <div class="actions" *ngIf="activeNode === node">
                    <button class="btn btn-light" (click)="nodeRemoveClicked(node, confirmRemoval, rejectRemoval)">
                        <fa-icon [icon]="['fas', 'times']"></fa-icon>
                    </button>
                </div>
            </ng-container>
        </section>
        <h6 id="ongoing-node-view-header" class="section-header p-1 border-bottom">
            Ongoing Queries
            <div class="form-check round-robin mr-2">
                <input class="form-check-input" type="checkbox" id="roundrobin"
                    [(ngModel)]="roundRobin" (change)="roundRobinChange()">
                <label class="form-check-label" for="roundrobin">
                    Round Robin
                </label>
            </div>
        </h6>
        <section id="ongoing-node-view" class="styled-scroll" [sortablejs]="ongoingNodes"
            [sortablejsOptions]="sortablejsOptions">
            <div *ngFor="let node of ongoingNodes">
                <div class="query d-flex flex-row" (click)="nodeSelected(node)"
                    [class.selected]="activeNode === node"
                    [class.highlighted]="highlightedNode === node">
                    <progress-ring
                        [processed]="node.query.recentProgress.processedPercent()"
                        [ongoing]="node.query.recentProgress.ongoingPercent()"
                        [style.opacity]="node.state === NodeState.Paused ? 0.2 : 1"></progress-ring>
                    <div class="field-names m-0 p-0 ml-2">
                        <div *ngFor="let field of node.fields">
                            <field-badge [field]="field"></field-badge>
                            {{ field.name }}
                        </div>
                        <div *ngIf="node.query.where.length > 0" class="filtered-by">
                            FILTERED BY
                        </div>
                        <div *ngFor="let pred of node.query.where.predicates">
                            <field-badge [field]="pred.target" class="mr-1"></field-badge>
                            <predicate-indicator [predicate]="pred"></predicate-indicator>
                        </div>
                    </div>
                    <fa-icon class="state-icon" [icon]="['fas', 'play']" [hidden]="engine.runningQuery != node.query || node.state === NodeState.Paused"></fa-icon>
                    <fa-icon class="state-icon" [icon]="['fas', 'pause']" [hidden]="node.state === NodeState.Running"></fa-icon>
                </div>
                <div class="actions" *ngIf="activeNode === node">
                    <button class="btn btn-light" [hidden]="activeNode.state === NodeState.Paused" (click)="activeNode.pause()">
                        <fa-icon [icon]="['fas', 'pause']"></fa-icon>
                    </button>
                    <button class="btn btn-light" [hidden]="activeNode.state === NodeState.Running" (click)="activeNode.run()">
                        <fa-icon [icon]="['fas', 'play']"></fa-icon>
                    </button>
                    <button class="btn btn-light" (click)="nodeRemoveClicked(node, confirmRemoval, rejectRemoval)">
                        <fa-icon [icon]="['fas', 'times']"></fa-icon>
                    </button>
                </div>
            </div>
        </section>
    </section>
    <section id="main" class="styled-scroll">
        <div *ngIf="!activeNode">
            <p>
                Choose a node to inspect.
            </p>
        </div>
        <div [hidden]="!activeNode">
            <vis #vis
            [node]="activeNode"
            (variableSelected)="variableSelected($event)"
            (constantSelected)="constantSelected($event)"
            (queryCreated)="queryCreated($event)"
            (numBinsChanged)="numBinsChanged()"
            (sgPanelRequested)="sgPanelRequested()"
            (dataViewerRequested)="dataViewerRequested($event)"
            ></vis>
        </div>
    </section>

    <section id="safeguard-view">
        <ul class="tab-list">
            <li>
                <h4 class="section-header p-2 border-bottom" (click)="toggle(SGT.Point)">
                    <fa-icon [icon]="['fas', 'times']" [hidden]="activeSafeguardPanel != SGT.Point"></fa-icon>
                    <fa-icon [icon]="['fas', 'plus']" [hidden]="activeSafeguardPanel == SGT.Point"></fa-icon>
                    Point <small>V(A) &lt; 5</small>
                </h4>
            </li>
            <li>
                <h4 class="section-header p-2 border-bottom" (click)="toggle(SGT.Range)">
                    <fa-icon [icon]="['fas', 'times']" [hidden]="activeSafeguardPanel != SGT.Range"></fa-icon>
                    <fa-icon [icon]="['fas', 'plus']" [hidden]="activeSafeguardPanel == SGT.Range"></fa-icon>
                    Range <small>V(A) ∈ [5, 10]</small>
                </h4>
            </li>
            <li>
                <h4 class="section-header p-2 border-bottom" (click)="toggle(SGT.Comparative)">
                    <fa-icon [icon]="['fas', 'times']" [hidden]="activeSafeguardPanel != SGT.Comparative"></fa-icon>
                    <fa-icon [icon]="['fas', 'plus']" [hidden]="activeSafeguardPanel == SGT.Comparative"></fa-icon>
                    Comparative <small>V(A) &lt; V(B)</small>
                </h4>
            </li>
            <li>
                <h4 class="section-header p-2" (click)="toggle(SGT.Distributive)" [class.disabled]="!isDistributivePossible">
                    <fa-icon [icon]="['fas', 'times']" [hidden]="activeSafeguardPanel != SGT.Distributive"></fa-icon>
                    <fa-icon [icon]="['fas', 'plus']" [hidden]="activeSafeguardPanel == SGT.Distributive"></fa-icon>
                    Distributive <small>V(·) ~ N(5, 2)</small>
                </h4>
            </li>
        </ul>
        <h3 class="section-header p-1 border-right-0 border-top border-bottom">
            Safeguard List
        </h3>
        <section id="safeguard-list" class="styled-scroll">
            <p *ngIf="safeguards.length === 0" class="m-0 guide p-1">
                The list is empty! Click on buttons below to create a safegaurd.
            </p>

            <sg-list-item *ngFor="let sg of safeguards.reverse()"
                [safeguard]="sg"
                (removeClicked)="sgRemoveClicked($event)"
                (mouseenter)="sgMouseEnter(sg)"
                (mouseleave)="sgMouseLeave(sg)"
                (click)="sgClick(sg)"
                ></sg-list-item>
        </section>
    </section>

    <section id="safeguard-config-view">
        <!-- Point -->
        <div class="border-top" [hidden]="activeSafeguardPanel != SGT.Point">
            <div class="display text-center p-2">
                <sg-point *ngIf="activeNode" [highlighted]="highlighted" [query]="activeNode.query" [variable]="variable1 || combinedVariable1"
                    [isRank]="useRank" [operator]="operator" [constant]="useRank ? pointRankConstant : pointValueConstant"
                    (highlight)="highlight($event)" (constantUserChanged)="constantUserChanged($event)" [editable]="true"></sg-point>
            </div>
            <div class="form-group-sm form-check m-0 mx-1" [hidden]="!rankAllowed()">
                <input type="checkbox" name="use_rank1" class="form-check-input" id="use-rank1" (change)="useRankToggled()"
                    [(ngModel)]="useRank">
                <label class="form-check-label guide" for="use-rank1">Use Rank</label>
            </div>
            <div class="alert guide p-2 m-1">
                <span class="tip">TIP</span>
                <span (mouseenter)="highlight(1)" (mouseleave)="highlight(0)">
                    Please pick a
                    <span class="variable1 font-weight-bold">variable</span>
                    by clicking on a category on the vertial axis of the chart.
                </span>
                <span (mouseenter)="highlight(3)" (mouseleave)="highlight(0)">
                    Once a variable is selected, choose a
                    <span class="constant font-weight-bold">constant</span>
                    by dragging the constant bar.
                </span>
            </div>
            <div class="guide p-1" *ngIf="activeNode && activeNode.query.visibleProgress.processedRows > 0
                && (variable1 || combinedVariable1)
                && pointValueConstant && !useRank
                && activeNode.query.approximator.estimatable">
                <p-indicator [p]="PointValueEstimate(activeNode.query, variable1 || combinedVariable1, operator, pointValueConstant)"></p-indicator>
            </div>
            <div class="guide p-1" *ngIf="activeNode && activeNode.query.visibleProgress.processedRows > 0
                    && (variable1 || combinedVariable1)
                    && pointValueConstant && !useRank
                    && !activeNode.query.approximator.estimatable">
                <truthiness-indicator [t]="PointMinMaxValueEstimate(activeNode.query, variable1 || combinedVariable1, operator, pointValueConstant)"></truthiness-indicator>
            </div>
            <div class="guide p-1" *ngIf="activeNode && activeNode.query.visibleProgress.processedRows > 0
                && variable1 && pointRankConstant && useRank
                && activeNode.query.approximator.estimatable">
                <p-indicator [p]="PointRankEstimate(activeNode.query, variable1, operator, pointRankConstant)"></p-indicator>
            </div>
            <div class="guide p-1" *ngIf="activeNode && activeNode.query.visibleProgress.processedRows > 0
                && variable1 && pointRankConstant && useRank
                && !activeNode.query.approximator.estimatable">
                <truthiness-indicator [t]="PointMinMaxRankEstimate(activeNode.query, variable1, operator, pointRankConstant)"></truthiness-indicator>
            </div>
            <div class="p-1 text-right">
                <button class="btn btn-success border-right-0 mr-1" (click)="createPointSafeguard()">
                    Create a Safeguard
                </button>
                <button class="btn btn-danger border-right-0" (click)="cancelSafeguard()">
                    Cancel
                </button>
            </div>
        </div>

        <!-- Range -->
        <div class="border-top" [hidden]="activeSafeguardPanel != SGT.Range">
            <div class="display text-center p-2">
                <sg-range *ngIf="activeNode" [highlighted]="highlighted" [query]="activeNode.query" [variable]="variable1 || combinedVariable1"
                    [constant]="useRank ? rangeRankConstant : rangeValueConstant" (highlight)="highlight($event)"
                    (constantUserChanged)="constantUserChanged($event)" [editable]="true"></sg-range>
            </div>
            <div class="alert guide p-2 m-1">
                <span class="tip">TIP</span>
                <span (mouseenter)="highlight(1)" (mouseleave)="highlight(0)">
                    Please pick a
                    <span class="variable1 font-weight-bold">variable</span>
                    by clicking on a category on the vertial axis of the chart.
                </span>
                <span (mouseenter)="highlight(3)" (mouseleave)="highlight(0)">
                    Once a variable is selected, choose a
                    <span class="constant font-weight-bold">range</span>
                    by dragging the edge of the range brush.
                </span>
            </div>
            <div class="guide p-1" *ngIf="activeNode && activeNode.query.visibleProgress.processedRows > 0 && activeSafeguardPanel === SGT.Range && (variable1 || combinedVariable1) && rangeValueConstant">
                <p-indicator [p]="RangeValueEstimate(activeNode.query, variable1 || combinedVariable1, Operators.InRange, rangeValueConstant)"></p-indicator>
            </div>
            <div class="p-1 text-right">
                <button class="btn btn-success border-right-0 mr-1" (click)="createRangeSafeguard()">
                    Create a Safeguard
                </button>
                <button class="btn btn-danger border-right-0" (click)="cancelSafeguard()">
                    Cancel
                </button>
            </div>
        </div>

        <!-- Comparative -->
        <div class="border-top" [hidden]="activeSafeguardPanel != SGT.Comparative">
            <div class="display text-center p-2">
                <sg-comparative *ngIf="activeNode" [highlighted]="highlighted" [query]="activeNode.query" [variable1]="variable1 || combinedVariable1"
                    [variable2]="variable2 || combinedVariable2" [operator]="operator" (highlight)="highlight($event)"></sg-comparative>
            </div>
            <div class="alert guide p-2 m-1">
                <span class="tip">TIP</span>
                <span (mouseenter)="highlight(1)" (mouseleave)="highlight(0)">
                    Please pick the
                    <span class="variable1 font-weight-bold">first variable</span>
                    by clicking on a category on the vertial axis of the chart.
                </span>
                <span (mouseenter)="highlight(4)" (mouseleave)="highlight(0)">
                    Then, pick the
                    <span class="variable2 font-weight-bold">second variable</span>
                    by <strong>right-clicking</strong> on a category.
                </span>
            </div>
            <div class="guide p-1" *ngIf="activeNode && activeNode.query.visibleProgress.processedRows > 0 && (variablePair || combinedVariablePair)">
                <p-indicator [p]="ComparativeEstimate(activeNode.query, variablePair || combinedVariablePair, operator)"></p-indicator>
            </div>
            <div class="p-1 text-right">
                <button class="btn btn-success border-right-0 mr-1" (click)="createComparativeSafeguard()">
                    Create a Safeguard
                </button>
                <button class="btn btn-danger border-right-0" (click)="cancelSafeguard()">
                    Cancel
                </button>
            </div>
        </div>

        <!-- Distributive -->
        <div class="border-top" [hidden]="activeSafeguardPanel != SGT.Distributive">
            <div class="p-1">
                <div class="form-check-inline form-control-sm">
                    Fitting Type:
                </div>
                <div class="form-check form-check-inline form-control-sm">
                    <input class="form-check-input" type="radio" name="distributive"
                        [checked]="!useNormal"
                        id="inlineRadio2" value="option2" (click)="useNormal=false;useNormalToggled()">
                    <label class="form-check-label" for="inlineRadio2">Power Law</label>
                </div>
                <div class="form-check form-check-inline form-control-sm">
                    <input class="form-check-input" type="radio" name="distributive"
                        [checked]="useNormal" [disabled]="!isNormalFittingAvailable"
                        id="inlineRadio1" value="option1" (click)="useNormal=true;useNormalToggled()">
                    <label class="form-check-label" for="inlineRadio1">Normal</label>
                </div>
            </div>
            <div class="display text-center p-2">
                <sg-distributive *ngIf="activeNode" [highlighted]="highlighted" [query]="activeNode.query" [constant]="useLinear ? linearRegressionConstant : (useNormal ? normalConstant : powerLawConstant)"
                    [groupBy]="activeNode.query.groupBy" (highlight)="highlight($event)"></sg-distributive>
            </div>
            <div class="p-1" *ngIf="activeNode && activeNode.query && activeNode.query.visibleProgress.processedRows > 0 && activeSafeguardPanel == SGT.Distributive">
                <div class="guide flex-grow-1" *ngIf="!useNormal && !useLinear">
                    <quality-indicator [q]="PowerLawEstimate(activeNode.query, powerLawConstant)"></quality-indicator>
                </div>
                <div class="guide flex-grow-1" *ngIf="useNormal && !useLinear">
                    <quality-indicator [q]="NormalEstimate(activeNode.query, normalConstant)"></quality-indicator>
                </div>
                <div class="guide flex-grow-1" *ngIf="useLinear">
                    <error-indicator [e]="LinearRegressionEstimate(activeNode.query, linearRegressionConstant)"></error-indicator>
                </div>
            </div>
            <div class="p-1 text-right">
                <button class="btn btn-success border-right-0 mr-1" (click)="createDistributiveSafeguard()">
                    Create a Safeguard
                </button>
                <button class="btn btn-danger border-right-0" (click)="cancelSafeguard()">
                    Cancel
                </button>
            </div>
        </div>
    </section>
    <metadata-editor [dataset]="engine.dataset" #metadataEditor id="metadata-editor" [hidden]="!metadataEditor.visible">
    </metadata-editor>
</div>

<ng-template #confirmRemoval let-c="close" let-d="dismiss">
    <div class="modal-header">
        <h4 class="modal-title">Removing a node</h4>
        <button type="button" class="close" aria-label="Close" (click)="d('Cross click')">
            <span aria-hidden="true">&times;</span>
        </button>
    </div>
    <div class="modal-body">
        <p>
            Are you sure?
        </p>
    </div>
    <div class="modal-footer">
        <button type="button" class="btn btn-danger" (click)="c()">Delete</button>
        <button type="button" class="btn btn-outline-secondary" (click)="d()">Cancel</button>
    </div>
</ng-template>

<ng-template #rejectRemoval let-c="close" let-d="dismiss">
    <div class="modal-header">
        <h4 class="modal-title">Error</h4>
        <button type="button" class="close" aria-label="Close" (click)="d('Cross click')">
            <span aria-hidden="true">&times;</span>
        </button>
    </div>
    <div class="modal-body">
        <p>
            You cannot remove a node that has a safeguard on it.
        </p>
    </div>
</ng-template>

<ng-template #dataViewerModal let-c="close" let-d="dismiss">
    <div class="modal-header">
        <h4 class="modal-title">Data Viewer <small>({{ filteredRows.length | number}} row{{ filteredRows.length == 1 ? '' : 's'}})</small></h4>
        <button type="button" class="close" aria-label="Close" (click)="d('Cross click')">
            <span aria-hidden="true">&times;</span>
        </button>
    </div>
    <div class="modal-body styled-scroll">
        <data-viewer
            [dataset]="engine.dataset"
            [rows]="filteredRows"
            ></data-viewer>
    </div>
</ng-template>

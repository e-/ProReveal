<div id="wrapper" (click)="wrapperClicked()">
    <section class="navbar navbar-dark bg-dark box-shadow d-flex justify-content-start" id="navbar">
        <button (click)="toggleMetadataEditor()" class="btn btn-dark" id="open-metadata-editor">
            <fa-icon icon="folder-open"></fa-icon>
        </button>
        <a href="#" class="navbar-brand">SPVA
            <small> (movies.json)</small>
        </a>
        <button class="btn btn-primary" (click)="run(1)">Run a job</button>
        &nbsp;
        <button class="btn btn-primary" (click)="run(10)">Run 10 jobs</button>
        &nbsp;
        <button class="btn btn-primary" (click)="run(100)">Run 100 jobs</button>
    </section>
    <section id="node-view">
        <section id="search">
            <div class="input-group">
                <div class="input-group-prepend">
                    <span class="input-group-text">
                        <fa-icon [icon]="['fas', 'search']"></fa-icon>
                    </span>
                </div>
                <input type="text" name="keyword" class="form-control" placeholder="Search" (input)="keywordSearched($event.target.value)"
                    [ngModel]="searchKeyword">
                <button class="btn btn-light" type="button" (click)="searchKeyword='';highlightedNodes=[]">
                    <fa-icon [icon]="['fas', 'times']"></fa-icon>
                </button>
            </div>
        </section>

        <h3 id="completed-node-view-header" class="section-header p-1 border-bottom border-right">Completed Queries</h3>
        <section id="completed-node-view" class="styled-scroll">
            <div *ngFor="let node of completedNodes" [class.highlighted]="highlightedNodes.includes(node)" (mouseenter)="hoveredNode = node"
                (mouseleave)="hoveredNode = null">
                <div class="query" (click)="nodeSelected(node)" [class.selected]="activeNode === node">
                    <progress-ring [processed]="node.query.progress.processedPercent()" [ongoing]="node.query.progress.ongoingPercent()"></progress-ring>
                    <ul class="field-names">
                        <li *ngFor="let field of node.fields">
                            <field-badge [field]="field"></field-badge>
                            {{ field.name }}
                        </li>
                    </ul>
                </div>
                <div class="actions" *ngIf="activeNode === node">
                    <button class="btn btn-light">
                        <fa-icon [icon]="['fas', 'trash']"></fa-icon>
                    </button>
                    <button class="btn btn-light" (click)="plusClicked($event, node)">
                        <fa-icon style="pointer-events: none" [icon]="['fas', 'plus']"></fa-icon>
                    </button>
                </div>
            </div>
        </section>
        <h6 id="ongoing-node-view-header" class="section-header p-1 border-bottom">Ongoing Queries</h6>
        <section id="ongoing-node-view" class="styled-scroll" [sortablejs]="ongoingNodes" [sortablejsOptions]="sortablejsOptions">
            <div *ngFor="let node of ongoingNodes" [class.highlighted]="highlightedNodes.includes(node)" (mouseenter)="hoveredNode = node"
                (mouseleave)="hoveredNode = null">
                <div class="query" (click)="nodeSelected(node)" [class.selected]="activeNode === node">
                    <progress-ring [processed]="node.query.progress.processedPercent()" [ongoing]="node.query.progress.ongoingPercent()"></progress-ring>
                    <ul class="field-names">
                        <li *ngFor="let field of node.fields">
                            <field-badge [field]="field"></field-badge>
                            {{ field.name }}
                        </li>
                    </ul>
                    <fa-icon class="state-icon" [icon]="['fas', 'play']" [hidden]="node.state === NodeState.Paused"></fa-icon>
                    <fa-icon class="state-icon" [icon]="['fas', 'pause']" [hidden]="node.state === NodeState.Running"></fa-icon>
                </div>
                <div class="actions" *ngIf="activeNode === node">
                    <button class="btn btn-light" [hidden]="activeNode.state === NodeState.Paused" (click)="activeNode.pause()">
                        <fa-icon [icon]="['fas', 'play']"></fa-icon>
                    </button>
                    <button class="btn btn-light" [hidden]="activeNode.state === NodeState.Running" (click)="activeNode.run()">
                        <fa-icon [icon]="['fas', 'pause']"></fa-icon>
                    </button>
                    <button class="btn btn-light" (click)="deleteClicked(confirmDelete, node)">
                        <fa-icon [icon]="['fas', 'trash']"></fa-icon>
                    </button>
                    <button class="btn btn-light" (click)="plusClicked($event, node)">
                        <fa-icon style="pointer-events: none" [icon]="['fas', 'plus']"></fa-icon>
                    </button>
                </div>
            </div>
        </section>

        <!--<section id="graph" class="styled-scroll">
            <exploration-view #explorationView
                [root]="explorationRoot"
                [hoveredNode]="hoveredNode"
                [activeNode]="activeNode"
                >
            </exploration-view>
        </section>-->
    </section>
    <section id="main" class="styled-scroll">
        <div *ngIf="!activeNode">
            <p>
                Choose a node to inspect.
            </p>
        </div>
        <div [hidden]="!activeNode">
            <vis #vis [node]="activeNode" (variableSelected)="variableSelected($event)" (constantSelected)="constantSelected($event)"
                (safeguardAdded)="safeguardAdded($event)"></vis>

        </div>
    </section>

    <section id="safeguard-view" class="border-left">
        <h3 class="section-header p-1 border-right-0 border-top border-bottom">
            Safeguard List
        </h3>
        <section id="safeguard-list" class="styled-scroll">
            <p *ngIf="safeguards.length === 0" class="m-0 guide p-1">
                The list is empty! Click on buttons below to create a safegaurd.
            </p>
            <div *ngFor="let sg of safeguards" class="safeguard">
                <sg-display [safeguard]="sg"></sg-display>
            </div>
        </section>
    </section>

    <section id="safeguard-config-view">
        <ul class="tab-list">
            <li>
                <h4 class="section-header p-2 border" (click)="toggle(SGT.Point)">
                    <fa-icon [icon]="['fas', 'caret-down']" [hidden]="activeSafeguardPanel != SGT.Point"></fa-icon>
                    <fa-icon [icon]="['fas', 'plus']" [hidden]="activeSafeguardPanel == SGT.Point"></fa-icon>
                    Point <small>V(A) &lt; 5</small>
                </h4>
            </li>
            <li>
                <h4 class="section-header p-2 border" (click)="toggle(SGT.Range)">
                    <fa-icon [icon]="['fas', 'caret-down']" [hidden]="activeSafeguardPanel != SGT.Range"></fa-icon>
                    <fa-icon [icon]="['fas', 'plus']" [hidden]="activeSafeguardPanel == SGT.Range"></fa-icon>
                    Range <small>V(A) ∈ [5, 10]</small>
                </h4>
            </li>
            <li>
                <h4 class="section-header p-2 border" (click)="toggle(SGT.Comparative)">
                    <fa-icon [icon]="['fas', 'caret-down']" [hidden]="activeSafeguardPanel != SGT.Comparative"></fa-icon>
                    <fa-icon [icon]="['fas', 'plus']" [hidden]="activeSafeguardPanel == SGT.Comparative"></fa-icon>
                    Comparative <small>V(A) &lt; V(B)</small>
                </h4>
            </li>
            <li>
                <h4 class="section-header p-2 border" (click)="toggle(SGT.Distributive)">
                    <fa-icon [icon]="['fas', 'caret-down']" [hidden]="activeSafeguardPanel != SGT.Distributive"></fa-icon>
                    <fa-icon [icon]="['fas', 'plus']" [hidden]="activeSafeguardPanel == SGT.Distributive"></fa-icon>
                    Distributive <small>V(·) ~ N(5, 2)</small>
                </h4>
            </li>
        </ul>

        <!-- Point -->
        <div class="border-top" [hidden]="activeSafeguardPanel != SGT.Point">
            <div class="display text-center p-2">
                <sg-point *ngIf="activeNode" [highlighted]="highlighted" [query]="activeNode.query" [variable]="variable1"
                    [useRank]="useRank" [operator]="operator" [constant]="useRank ? pointRankConstant : pointValueConstant"
                    (highlight)="highlight($event)"></sg-point>
            </div>
            <div (mouseenter)="highlight(1)" (mouseleave)="highlight(0)">
                <h5 class="section-subheader p-1 border border-right-0">
                    <fa-icon [icon]="['fas', 'circle']" transform="shrink-9" class="variable1"></fa-icon>
                    Variable
                </h5>
                <p class="p-1 guide m-0">
                    Please pick a <span class="variable1 font-weight-bold">variable</span> by clicking on a category on
                    the chart.
                </p>
                <div class="form-group-sm form-check m-0 mx-1" [hidden]="!rankAllowed()">
                    <input type="checkbox" name="use_rank1" class="form-check-input" id="use-rank1" (change)="useRankToggled()"
                        [(ngModel)]="useRank">
                    <label class="form-check-label guide" for="use-rank1">Use Rank</label>
                </div>
            </div>
            <div (mouseenter)="highlight(3)" (mouseleave)="highlight(0)">
                <h5 class="section-subheader p-1 border border-right-0" [hidden]="useRank">
                    <fa-icon [icon]="['fas', 'circle']" transform="shrink-9" class="constant"></fa-icon>
                    Constant
                </h5>
                <div class="p-1 guide m-0" [hidden]="useRank">
                    <p class="m-0">
                        Please select a <span class="constant font-weight-bold">constant</span> by moving the line.
                    </p>
                    <input type="text" class="form-control form-control-sm" [ngModel]="pointValueConstant.value | number: numberFormat"
                        (change)="pointValueConstant.value=toNumber($event.target.value); constantUserChanged(pointValueConstant, $event)">
                </div>
                <h5 class="section-subheader p-1 border border-right-0" [hidden]="!useRank">
                    <fa-icon [icon]="['fas', 'circle']" transform="shrink-9" class="constant"></fa-icon>
                    Rank Constant
                </h5>
                <div class="p-1 guide m-0" [hidden]="!useRank">
                    <p class="m-0">
                        Please select a <span class="constant font-weight-bold">constant</span> by moving the line.
                    </p>
                    <input type="number" class="form-control form-control-sm" [ngModel]="pointRankConstant.rank | number: rankFormat"
                        (change)="pointRankConstant.rank=$event.target.value; constantUserChanged($event)">
                </div>
            </div>
            <div class="p-1 guide">
                <div *ngIf="activeNode && activeNode.query.progress.processedRows > 0 && variable1 && pointValueConstant">
                    <p-indicator [p]="PointValueEstimate(activeNode.query, variable1, operator, pointValueConstant)"></p-indicator>
                </div>
            </div>
            <div class="p-1">
                <button class="btn btn-success w-75 rounded-0 border-right-0" (click)="createPointSafeguard()">
                    Create a Safeguard
                </button>
                <button class="btn btn-danger w-25 rounded-0 border-right-0" (click)="cancelSafeguard()">
                    <span aria-hidden="true">&times;</span>
                </button>
            </div>
        </div>

        <!-- Range -->
        <div class="border-top" [hidden]="activeSafeguardPanel != SGT.Range">
            <div class="display text-center p-2">
                <sg-range *ngIf="activeNode" [highlighted]="highlighted" [query]="activeNode.query" [variable]="variable1"
                    [constant]="useRank ? rangeRankConstant : rangeValueConstant" (highlight)="highlight($event)"></sg-range>
            </div>
            <div (mouseenter)="highlight(1)" (mouseleave)="highlight(0)">
                <h5 class="section-subheader p-1 border border-right-0">
                    <fa-icon [icon]="['fas', 'circle']" transform="shrink-9" class="variable1"></fa-icon>
                    Variable
                </h5>
                <p class="p-1 guide m-0">
                    Please pick a <span class="variable1 font-weight-bold">variable</span> by clicking on a category on
                    the chart.
                </p>
                <!--<div class="form-group-sm form-check m-0 mx-1" [hidden]="!rankAllowed()">
                    <input type="checkbox" name="use_rank1" class="form-check-input" id="use-rank1" (change)="useRankToggled()"
                         [(ngModel)]="useRank">
                    <label class="form-check-label guide" for="use-rank1">Use Rank</label>
                </div>-->
            </div>
            <div (mouseenter)="highlight(3)" (mouseleave)="highlight(0)">
                <h5 class="section-subheader p-1 border border-right-0" [hidden]="useRank">
                    <fa-icon [icon]="['fas', 'circle']" transform="shrink-9" class="constant"></fa-icon>
                    Constant
                </h5>
                <div class="p-1 guide m-0" [hidden]="useRank">
                    <p class="m-0">
                        Please select a <span class="constant font-weight-bold">constant</span> by moving the line.
                    </p>
                    <input type="text" class="form-control form-control-sm mb-1" [ngModel]="rangeValueConstant.from | number: numberFormat"
                        (change)="rangeValueConstant.from=toNumber($event.target.value); checkOrder(); constantUserChanged(rangeValueConstant)">
                    <input type="text" class="form-control form-control-sm" [ngModel]="rangeValueConstant.to | number: numberFormat"
                        (change)="rangeValueConstant.to=toNumber($event.target.value); checkOrder(); constantUserChanged(rangeValueConstant)">
                </div>
                <h5 class="section-subheader p-1 border border-right-0" [hidden]="!useRank">
                    <fa-icon [icon]="['fas', 'circle']" transform="shrink-9" class="constant"></fa-icon>
                    Rank Constants
                </h5>
                <div class="p-1 guide m-0" [hidden]="!useRank">
                    <p class="m-0">
                        Please select a <span class="constant font-weight-bold">constant</span> by moving the line.
                    </p>
                    <input type="number" class="form-control form-control-sm mb-1" [ngModel]="rangeRankConstant.from | number: rankFormat"
                        (change)="rangeRankConstant.from=$event.target.value; checkOrder(); constantUserChanged(rangeRankConstant)">
                    <input type="number" class="form-control form-control-sm" [ngModel]="rangeRankConstant.to | number: rankFormat"
                        (change)="rangeRankConstant.to=$event.target.value; checkOrder(); constantUserChanged(rangeRankConstant)">
                </div>
            </div>
            <div class="p-1 guide">
                <div *ngIf="activeNode && activeNode.query.progress.processedRows > 0 && variable1 && rangeValueConstant">
                    <p-indicator [p]="RangeValueEstimate(activeNode.query, variable1, Operators.InRange, rangeValueConstant)"></p-indicator>
                </div>
            </div>
            <div class="p-1">
                <button class="btn btn-success w-75 rounded-0 border-right-0" (click)="createRangeSafeguard()">
                    Create a Safeguard
                </button>
                <button class="btn btn-danger w-25 rounded-0 border-right-0" (click)="cancelSafeguard()">
                    <span aria-hidden="true">&times;</span>
                </button>
            </div>
        </div>

        <!-- Comparative -->
        <div class="border-top" [hidden]="activeSafeguardPanel != SGT.Comparative">
            <div class="display text-center p-2">
                <sg-comparative *ngIf="activeNode" [highlighted]="highlighted" [query]="activeNode.query" [variable1]="variable1"
                    [variable2]="variable2" [operator]="operator" (highlight)="highlight($event)"></sg-comparative>
            </div>
            <div (mouseenter)="highlight(1)" (mouseleave)="highlight(0)">
                <h5 class="section-subheader p-1 border border-right-0">
                    <fa-icon [icon]="['fas', 'circle']" transform="shrink-9" class="variable1"></fa-icon>
                    1st Variable
                </h5>
                <p class="p-1 guide m-0">
                    Please pick the <span class="variable1 font-weight-bold">first variable</span> by clicking on a
                    category on the chart.
                </p>
            </div>
            <div (mouseenter)="highlight(4)" (mouseleave)="highlight(0)">
                <h5 class="section-subheader p-1 border border-right-0">
                    <fa-icon [icon]="['fas', 'circle']" transform="shrink-9" class="variable2"></fa-icon>
                    2nd Variable
                </h5>
                <div class="p-1 guide m-0">
                    <p class="m-0">
                        Please pick the <span class="variable2 font-weight-bold">second variable</span> by <em>right-</em>clicking
                        on a category on the chart.
                    </p>
                </div>
            </div>
            <div class="p-1 guide">
                <div *ngIf="activeNode && activeNode.query.progress.processedRows > 0 && variable1 && variable2">
                    <p-indicator [p]="ComparativeEstimate(activeNode.query, variablePair, operator)"></p-indicator>
                </div>
            </div>
            <div class="p-1">
                <button class="btn btn-success w-75 rounded-0 border-right-0" (click)="createComparativeSafeguard()">
                    Create a Safeguard
                </button>
                <button class="btn btn-danger w-25 rounded-0 border-right-0" (click)="cancelSafeguard()">
                    <span aria-hidden="true">&times;</span>
                </button>
            </div>
        </div>

        <!-- Distributive -->
        <div class="border-top" [hidden]="activeSafeguardPanel != SGT.Distributive">
            <div class="form-check form-check-inline guide">
                <input class="form-check-input" type="radio" name="inlineRadioOptions" id="inlineRadio1" value="option1"
                    [checked]="!useGaussian">
                <label class="form-check-label" for="inlineRadio1" (click)="useGaussian=false;useGaussianToggled()">Power-Law</label>
            </div>
            <div class="form-check form-check-inline guide">
                <input class="form-check-input" type="radio" name="inlineRadioOptions" id="inlineRadio2" value="option2"
                    [checked]="!useGaussian">
                <label class="form-check-label" for="inlineRadio2" (click)="useGaussian=true;useGaussianToggled()">Normal</label>
            </div>
            <div class="display text-center p-2">
                <sg-distributive *ngIf="activeNode" [highlighted]="highlighted" [query]="query" [constant]="useGaussian ? gaussianConstant : powerLawConstant"
                    (highlight)="highlight($event)"></sg-distributive>
            </div>
            <button class="btn btn-warning w-100 rounded-0 mb-2" (click)="fit()">Fit</button>
            <button class="btn btn-success w-75 rounded-0 border-right-0" (click)="createDistributiveSafeguard()">
                Create a Safeguard
            </button>
            <button class="btn btn-danger w-25 rounded-0 border-right-0" (click)="cancelSafeguard()">
                <span aria-hidden="true">&times;</span>
            </button>
        </div>
    </section>
    <metadata-editor [dataset]="dataset" #metadataEditor id="metadata-editor" [hidden]="!metadataEditor.visible">
    </metadata-editor>

    <!-- <section style="padding:5px; grid-row:2; grid-column:2;">

    </section>
    <queue-view [queue]="engine.queue" *ngIf="engine"></queue-view> -->
</div>

<field-selector #fieldSelector (fieldSelected)="fieldSelected($event.node, $event.field)"></field-selector>

<ng-template #confirmDelete let-c="close" let-d="dismiss">
    <div class="modal-header">
        <h4 class="modal-title" id="modal-basic-title">Confirm Deletion</h4>
        <button type="button" class="close" aria-label="Close" (click)="d('Cross click')">
            <span aria-hidden="true">&times;</span>
        </button>
    </div>
    <div class="modal-body">
        <p>
            Are you sure?
        </p>
    </div>
    <div class="modal-footer">
        <button type="button" class="btn btn-danger" (click)="c()">Delete</button>
        <button type="button" class="btn btn-outline-secondary" (click)="d()">Cancel</button>
    </div>
</ng-template>
